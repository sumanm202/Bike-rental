version: 1
services:
  - type: web
    name: bike-rental-web-jkgi
    env: python
    plan: free
    branch: main

    # Use Poetry to install dependencies and run Django commands inside Poetry's venv
    buildCommand: >
      bash -lc '
      echo "Installing dependencies with Poetry...";
      poetry install --no-interaction --no-ansi || { echo "poetry install failed"; exit 1; };
      echo "Running migrations and collectstatic via poetry run python...";
      poetry run python manage.py migrate --noinput || { echo "migrate failed"; exit 1; };
      poetry run python manage.py collectstatic --noinput || { echo "collectstatic failed"; exit 1; };
      '

    startCommand: >
      bash -lc '
      # run gunicorn from the environment; poetry run ensures correct venv
      exec poetry run gunicorn config.wsgi:application --bind 0.0.0.0:$PORT
      '

    healthCheckPath: /

    envVars:
      - key: SECRET_KEY
        value: ""
        scope: private

      - key: DEBUG
        value: "False"
        scope: private

      - key: STRIPE_SECRET_KEY
        value: ""
        scope: private

      - key: STRIPE_PUBLISHABLE_KEY
        value: ""
        scope: private

      - key: STRIPE_WEBHOOK_SECRET
        value: ""
        scope: private

      - key: DATABASE_URL
        value: ""
        scope: private
